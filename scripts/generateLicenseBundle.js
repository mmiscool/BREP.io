import { execSync } from 'child_process';
import { readFileSync, writeFileSync, mkdirSync } from 'fs';
import path from 'path';

const run = (cmd) => execSync(cmd, { encoding: 'utf-8', stdio: ['ignore', 'pipe', 'pipe'] });

const rootDir = process.cwd();
const packageJsonPath = path.join(rootDir, 'package.json');
const licensePath = path.join(rootDir, 'LICENSE.md');
const outputDir = path.join(rootDir, 'src', 'generated');
const outputPath = path.join(outputDir, 'licenseBundle.js');

const packageJson = JSON.parse(readFileSync(packageJsonPath, 'utf-8'));
const packageName = packageJson.name ?? 'package';
const packageLicense = packageJson.license ?? 'UNKNOWN';
const licenseText = readFileSync(licensePath, 'utf-8').trimEnd();

let data;
try {
  const raw = run('pnpm licenses list --prod --long --json');
  data = JSON.parse(raw);
} catch (error) {
  console.error('Failed to generate license bundle. Is pnpm installed and did you run `pnpm install`?');
  console.error(error?.message ?? error);
  process.exit(1);
}

const licenseKeys = Object.keys(data).sort((a, b) => a.localeCompare(b));
const countPackages = licenseKeys.reduce(
  (total, key) => total + (Array.isArray(data[key]) ? data[key].length : 0),
  0
);

const formatAuthor = (author) => {
  if (!author) return '';
  if (typeof author === 'string') return author.trim();
  if (typeof author === 'object') {
    return String(author.name ?? '').trim();
  }
  return '';
};

const formatPackageLine = (pkg) => {
  const name = String(pkg?.name ?? 'unknown');
  const versions = Array.isArray(pkg?.versions)
    ? Array.from(new Set(pkg.versions.map((v) => String(v))))
    : [];
  const versionText = versions.length ? `@${versions.join(', ')}` : '';
  const desc = pkg?.description ? ` — ${String(pkg.description)}` : '';
  const author = formatAuthor(pkg?.author);
  const authorText = author ? ` — Author: ${author}` : '';
  const homepage = pkg?.homepage ? ` — ${String(pkg.homepage)}` : '';
  return `- ${name}${versionText}${desc}${authorText}${homepage}`;
};

const lines = [];
lines.push(`${packageName} License`);
lines.push(`License: ${packageLicense}`);
lines.push('');
lines.push(licenseText);
lines.push('');
lines.push('Third-party licenses (production dependencies)');
lines.push(`${countPackages} packages • ${licenseKeys.length} license types`);
lines.push('Generated from: pnpm licenses list --prod --long --json');
lines.push('');

for (const licenseName of licenseKeys) {
  const list = Array.isArray(data[licenseName]) ? data[licenseName] : [];
  list.sort((a, b) => String(a?.name ?? '').localeCompare(String(b?.name ?? '')));
  lines.push(`${licenseName} (${list.length} package${list.length === 1 ? '' : 's'})`);
  for (const pkg of list) {
    lines.push(formatPackageLine(pkg));
  }
  lines.push('');
}

const bundleText = lines.join('\n').trimEnd();
const output = `// Auto-generated by scripts/generateLicenseBundle.js
export const LICENSE_BUNDLE_TEXT = ${JSON.stringify(bundleText)};
`;

mkdirSync(outputDir, { recursive: true });
writeFileSync(outputPath, output, 'utf-8');
console.log(`Wrote ${outputPath}`);
